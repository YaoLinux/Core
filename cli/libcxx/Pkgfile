makedepends=(cmake libunwind)

url="http://libcxx.llvm.org/"
description="A new implementation of the C++ standard library, targeting C++11."

packager="Yaolinux Team"
maintainer="rems"

PKGMK_IGNORE_UNPACK="yes"

run=(python)

name=libcxx
version=8.0.1

source=(https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/llvm-$version.src.tar.xz
        https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/libcxx-$version.src.tar.xz
        https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/libcxxabi-$version.src.tar.xz)

prepare() {
  [[ -d llvm ]] || mkdir llvm
  bsdtar --strip-components 1 --uid 0 --gid 0 -zxf \
         llvm-$version.src.tar.xz -C \
         llvm
  [[ -d llvm/projects/libcxx ]] || mkdir llvm/projects/libcxx
  bsdtar --strip-components 1 --uid 0 --gid 0 -zxf \
         libcxx-$version.src.tar.xz -C \
         llvm/projects/libcxx
  [[ -d llvm/projects/libcxxabi ]] || mkdir  llvm/projects/libcxxabi
  bsdtar --strip-components 1 --uid 0 --gid 0 -zxf \
         libcxxabi-$version.src.tar.xz -C \
         llvm/projects/libcxxabi
  sed -i 's/CREDITS.TXT/CREDITS/' llvm/projects/libcxx/LICENSE.TXT
  sed -i 's/CREDITS.TXT/CREDITS/' llvm/projects/libcxxabi/LICENSE.TXT
  [[ -d build ]] || mkdir build
}
 
build() {
  cd build
  CC=gcc CXX=g++ cmake \
    -G "Unix Makefiles" \
    -DLIBCXX_ENABLE_EXPERIMENTAL_LIBRARY=On \
    -DLIBCXX_INSTALL_EXPERIMENTAL_LIBRARY=Off \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    ../llvm
  make cxx cxx_experimental
}

package() {

  cd build
  make DESTDIR=$PKG/ install-libcxx
  install -Dm644 ../llvm/projects/libcxx/CREDITS.TXT $PKG/usr/share/licenses/${name}/CREDITS"
  install -Dm644 ../llvm/projects/libcxx/LICENSE.TXT $PKG/usr/share/licenses/${name}/LICENSE"

  make DESTDIR=$PKG/ install-libcxxabi
  install -Dm644 include/c++/v1/cxxabi.h $PKG/usr/include/c++/v1/cxxabi.h"
  install -Dm644 include/c++/v1/__cxxabi_config.h $PKG/usr/include/c++/v1/__cxxabi_config.h"
  install -Dm644 ../llvm/projects/libcxxabi/CREDITS.TXT $PKG/usr/share/licenses/${name}/CREDITS"
  install -Dm644 ../llvm/projects/libcxxabi/LICENSE.TXT $PKG/usr/share/licenses/${name}/LICENSE"

  install -Dm644 lib/libc++experimental.a $PKG/usr/lib/libc++experimental.a
  install -Dm644 ../llvm/projects/libcxx/CREDITS.TXT $PKG/usr/share/licenses/${name}/CREDITS"
  install -Dm644 ../llvm/projects/libcxx/LICENSE.TXT $PKG/usr/share/licenses/${name}/LICENSE"
}
