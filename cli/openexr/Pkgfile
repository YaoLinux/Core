makedepends=(python-numpy boost cmake zlib chrpath)

description="An high dynamic-range image file format library"
url="http://www.openexr.org"

packager="Yaolinux Team"
maintainer="rems"

name=openexr
version=2.4.1
release=2

PKGMK_KEEP_SOURCES="no"

source=(https://github.com/openexr/openexr/archive/v$version.tar.gz)

prepare() {

cd $name-$version

# Take DESTDIR into account when creating symlinks
  sed -e 's|chdir ${CMAKE_INSTALL_FULL_LIBDIR}|chdir \\$ENV\\{DESTDIR\\}${CMAKE_INSTALL_FULL_LIBDIR}|' \
    -i OpenEXR/config/LibraryDefine.cmake -i IlmBase/config/LibraryDefine.cmake

# Fix linking python modules to boost_python
  sed -e 's|${libname} ${extraDeps}|${libname} ${extraDeps} Boost::${PYILMBASE_BOOST_PY3_COMPONENT}|' -i PyIlmBase/config/ModuleDefine.cmake
}

build() {

mkdir build && cd build

cmake -DCMAKE_INSTALL_PREFIX=/usr \
      ../$name-$version

make
make DESTDIR=$PKG install

# Fix pc include path
  sed -e 's|=include|=${prefix}/include|g' -e 's|=lib|=${prefix}/lib|g' \
    -i "$PKG"/usr/lib/pkgconfig/OpenEXR.pc -i "$PKG"/usr/lib/pkgconfig/IlmBase.pc

# Install python modules
  _pythonpath=`python -c "from sysconfig import get_path; print(get_path('platlib'))"`
  install -Dm755 python3*/*.so -t "$PKG"/$_pythonpath 
  chrpath -d "$PKG"/$_pythonpath/*.so # Remove insecure RPATH
}

uptodate() {
local url ext
url="http://download.savannah.nongnu.org/releases/$name/"
ext=".tar.gz"
lynx -read_timeout=20 -dump -listonly -nonumbers \
$url?C=M\;O=A|grep $name-[0-9]|grep [0-9]$ext$| \
sed "s@$url$name-@@"|sed "s@$ext@@"|tail -1
}
