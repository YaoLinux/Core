makedepends=(xorgproto pkg-config libtool xorg-libxrandr wayland wayland-protocols xorg-libx11 xorg-libdrm xorg-libxext xorg-libxdamage expat llvm elfutils xorg-libxshmfence libva libvdpau python-mako python-beaker python-markupsafe lm-sensors)

description="Mesa is an OpenGL compatible 3D graphics library."
url="http://www.xorg-mesa3d.org"

packager="Yaolinux Team"
maintainer="rems"

alias=(xorg-mesa Mesa mesa3d Mesa3D mesa3)

run=(python python-mako python-beaker python-markupsafe)

name=mesa
version=19.3.3

source=(https://mesa.freedesktop.org/archive/mesa-$version.tar.xz
	http://www.linuxfromscratch.org/patches/downloads/mesa/mesa-$version-add_xdemos-1.patch
        http://www.linuxfromscratch.org/patches/blfs/svn/mesa-$version-fix_svga_vmwgfx_segfaults-1.patch)

prepare() {
cd mesa-$version
patch -Np1 -i ../mesa-$version-add_xdemos-1.patch
patch -Np1 -i ../mesa-$version-fix_svga_vmwgfx_segfaults-1.patch

sed '1s@python@&3@' -i bin/symbols-check.py

mkdir -v ../build
}

build() {

cd build

meson --prefix=/usr                  \
      --sysconfdir=/etc              \
      -Dllvm=true                    \
      -Dosmesa=gallium               \
      -Dgallium-xa=true              \
      -Dglx=dri                      \
      -Dgles2=true                   \
      -Dplatforms="drm,x11,wayland"  \
      -Ddri-drivers="i915,i965,nouveau,r200" \
      -Dgallium-drivers="nouveau,virgl,r300,r600,radeonsi,svga,swrast" \
      -Dvulkan-drivers="intel,amd" \
      -Dlmsensors=true \
      -Dgallium-vdpau=true \
      ../$name-$version

ninja 
DESTDIR=$PKG ninja install

install -v -dm755 $PKG/usr/share/doc/mesa-$version
cp -rfv ../$name-$version/docs/* $PKG/usr/share/doc/mesa-$version
}
