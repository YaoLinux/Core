makedepends=(dconf iso-codes gobject-introspection gtk2 libnotify vala python python-gobject gnome-common libxkbcommon dbus-python python2-xdg cldr-emoji-annotation)

description="IBus is an Intelligent Input Bus."
url="http://ibus.googlecode.com"

packager="Yaolinux Team"

name=ibus
version=1.5.21

PKGMK_IGNORE_UNPACK="yes"

source=(https://github.com/ibus/ibus/releases/download/$version/$name-$version.tar.gz
        http://www.unicode.org/Public/emoji/11.0/emoji-data.txt
        http://www.unicode.org/Public/emoji/11.0/emoji-sequences.txt
        http://www.unicode.org/Public/emoji/11.0/emoji-test.txt
        http://www.unicode.org/Public/emoji/11.0/emoji-variation-sequences.txt
        http://www.unicode.org/Public/emoji/11.0/emoji-zwj-sequences.txt
        https://www.unicode.org/Public/zipped/12.1.0/UCD.zip
        https://www.unicode.org/Public/zipped/12.1.0/Unihan.zip)

prepare() {

tar -xf $name-$version.tar.gz

for file in data sequences test variation-sequences zwj-sequences; do
    install -Dm644 emoji-$file.txt "$PKG/usr/share/unicode/emoji/emoji-$file.txt"
  done

for file in data sequences test variation-sequences zwj-sequences; do
    install -Dm644 emoji-$file.txt "/usr/share/unicode/emoji/emoji-$file.txt"
  done

for file in UCD Unihan; do
    install -Dm644 $file.zip "$PKG/usr/share/unicode/$file.zip"
    bsdtar -C "$PKG/usr/share/unicode" -x --no-same-owner --no-same-permissions -f $file.zip
  done

for file in UCD Unihan; do
    install -Dm644 $file.zip "/usr/share/unicode/$file.zip"
    bsdtar -C "/usr/share/unicode" -x --no-same-owner --no-same-permissions -f $file.zip
  done

# FS#49938: A bunch of compatibility symlinks
  ln -s . "$PKG/usr/share/unicode/ucd"
  for file in $name unicode-data unidata; do
    ln -s unicode "$PKG/usr/share/$file"
  done

ln -s . "/usr/share/unicode/ucd"
  for file in $name unicode-data unidata; do
    ln -s unicode "/usr/share/$file"
  done
}

build() {
cd $name-$version

  sed -i 's|$(libibus) $(libibus_emoji_dialog)|$(libibus_emoji_dialog) $(libibus)|' ui/gtk3/Makefile.am

./autogen.sh --prefix=/usr           \
             --sysconfdir=/etc       \
             --enable-wayland        \
             --enable-ui             \
             --enable-python-library \
             --with-python=python3   

rm -r "$PKG"/usr/lib/python2.7/site-packages/gi # compiled pyc/pyo files were not cleaned

make
make DESTDIR=$PKG install
}